Math.deg=function(a){return degrees=360*a/(2*Math.PI)};Math.rad=function(a){return radians=2*Math.PI*a/360};var Sylvester={version:"0.1.3",precision:1.0E-6};function Vector(){}
Vector.prototype={e:function(a){return a<1||a>this.elements.length?null:this.elements[a-1]},dimensions:function(){return this.elements.length},modulus:function(){return Math.sqrt(this.dot(this))},eql:function(a){var b=this.elements.length;a=a.elements||a;if(b!=a.length)return false;do if(Math.abs(this.elements[b-1]-a[b-1])>Sylvester.precision)return false;while(--b);return true},dup:function(){return Vector.create(this.elements)},map:function(a){var b=[];this.each(function(c,d){b.push(a(c,d))});return Vector.create(b)},
each:function(a){var b=this.elements.length,c=b,d;do{d=c-b;a(this.elements[d],d+1)}while(--b)},toUnitVector:function(){var a=this.modulus();if(a===0)return this.dup();return this.map(function(b){return b/a})},angleFrom:function(a){var b=a.elements||a;if(this.elements.length!=b.length)return null;var c=0,d=0,e=0;this.each(function(f,g){c+=f*b[g-1];d+=f*f;e+=b[g-1]*b[g-1]});d=Math.sqrt(d);e=Math.sqrt(e);if(d*e===0)return null;a=c/(d*e);if(a<-1)a=-1;if(a>1)a=1;return Math.acos(a)},isParallelTo:function(a){a=
this.angleFrom(a);return a===null?null:a<=Sylvester.precision},isAntiparallelTo:function(a){a=this.angleFrom(a);return a===null?null:Math.abs(a-Math.PI)<=Sylvester.precision},isPerpendicularTo:function(a){a=this.dot(a);return a===null?null:Math.abs(a)<=Sylvester.precision},add:function(a){var b=a.elements||a;if(this.elements.length!=b.length)return null;return this.map(function(c,d){return c+b[d-1]})},subtract:function(a){var b=a.elements||a;if(this.elements.length!=b.length)return null;return this.map(function(c,
d){return c-b[d-1]})},multiply:function(a){return this.map(function(b){return b*a})},x:function(a){return this.multiply(a)},dot:function(a){a=a.elements||a;var b=0,c=this.elements.length;if(c!=a.length)return null;do b+=this.elements[c-1]*a[c-1];while(--c);return b},cross:function(a){a=a.elements||a;if(this.elements.length!=3||a.length!=3)return null;var b=this.elements;return Vector.create([b[1]*a[2]-b[2]*a[1],b[2]*a[0]-b[0]*a[2],b[0]*a[1]-b[1]*a[0]])},max:function(){var a=0,b=this.elements.length,
c=b,d;do{d=c-b;if(Math.abs(this.elements[d])>Math.abs(a))a=this.elements[d]}while(--b);return a},indexOf:function(a){var b=null,c=this.elements.length,d=c,e;do{e=d-c;if(b===null&&this.elements[e]==a)b=e+1}while(--c);return b},toDiagonalMatrix:function(){return Matrix.Diagonal(this.elements)},round:function(){return this.map(function(a){return Math.round(a)})},snapTo:function(a){return this.map(function(b){return Math.abs(b-a)<=Sylvester.precision?a:b})},distanceFrom:function(a){if(a.anchor)return a.distanceFrom(this);
var b=a.elements||a;if(b.length!=this.elements.length)return null;var c=0,d;this.each(function(e,f){d=e-b[f-1];c+=d*d});return Math.sqrt(c)},liesOn:function(a){return a.contains(this)},liesIn:function(a){return a.contains(this)},rotate:function(a,b){var c,d,e,f;switch(this.elements.length){case 2:c=b.elements||b;if(c.length!=2)return null;d=Matrix.Rotation(a).elements;e=this.elements[0]-c[0];f=this.elements[1]-c[1];return Vector.create([c[0]+d[0][0]*e+d[0][1]*f,c[1]+d[1][0]*e+d[1][1]*f]);case 3:if(!b.direction)return null;
var g=b.pointClosestTo(this).elements;d=Matrix.Rotation(a,b.direction).elements;e=this.elements[0]-g[0];f=this.elements[1]-g[1];c=this.elements[2]-g[2];return Vector.create([g[0]+d[0][0]*e+d[0][1]*f+d[0][2]*c,g[1]+d[1][0]*e+d[1][1]*f+d[1][2]*c,g[2]+d[2][0]*e+d[2][1]*f+d[2][2]*c]);default:return null}},reflectionIn:function(a){if(a.anchor){var b=this.elements.slice();a=a.pointClosestTo(b).elements;return Vector.create([a[0]+(a[0]-b[0]),a[1]+(a[1]-b[1]),a[2]+(a[2]-(b[2]||0))])}else{var c=a.elements||
a;if(this.elements.length!=c.length)return null;return this.map(function(d,e){return c[e-1]+(c[e-1]-d)})}},to3D:function(){var a=this.dup();switch(a.elements.length){case 3:break;case 2:a.elements.push(0);break;default:return null}return a},inspect:function(){return"["+this.elements.join(", ")+"]"},setElements:function(a){this.elements=(a.elements||a).slice();return this}};Vector.create=function(a){return(new Vector).setElements(a)};Vector.i=Vector.create([1,0,0]);Vector.j=Vector.create([0,1,0]);
Vector.k=Vector.create([0,0,1]);Vector.Random=function(a){var b=[];do b.push(Math.random());while(--a);return Vector.create(b)};Vector.Zero=function(a){var b=[];do b.push(0);while(--a);return Vector.create(b)};function Matrix(){}
Matrix.prototype={e:function(a,b){if(a<1||a>this.elements.length||b<1||b>this.elements[0].length)return null;return this.elements[a-1][b-1]},row:function(a){if(a>this.elements.length)return null;return Vector.create(this.elements[a-1])},col:function(a){if(a>this.elements[0].length)return null;var b=[],c=this.elements.length,d=c,e;do{e=d-c;b.push(this.elements[e][a-1])}while(--c);return Vector.create(b)},dimensions:function(){return{rows:this.elements.length,cols:this.elements[0].length}},rows:function(){return this.elements.length},
cols:function(){return this.elements[0].length},eql:function(a){a=a.elements||a;if(typeof a[0][0]=="undefined")a=Matrix.create(a).elements;if(this.elements.length!=a.length||this.elements[0].length!=a[0].length)return false;var b=this.elements.length,c=b,d,e,f=this.elements[0].length,g;do{d=c-b;e=f;do{g=f-e;if(Math.abs(this.elements[d][g]-a[d][g])>Sylvester.precision)return false}while(--e)}while(--b);return true},dup:function(){return Matrix.create(this.elements)},map:function(a){var b=[],c=this.elements.length,
d=c,e,f,g=this.elements[0].length,h;do{e=d-c;f=g;b[e]=[];do{h=g-f;b[e][h]=a(this.elements[e][h],e+1,h+1)}while(--f)}while(--c);return Matrix.create(b)},isSameSizeAs:function(a){a=a.elements||a;if(typeof a[0][0]=="undefined")a=Matrix.create(a).elements;return this.elements.length==a.length&&this.elements[0].length==a[0].length},add:function(a){var b=a.elements||a;if(typeof b[0][0]=="undefined")b=Matrix.create(b).elements;if(!this.isSameSizeAs(b))return null;return this.map(function(c,d,e){return c+
b[d-1][e-1]})},subtract:function(a){var b=a.elements||a;if(typeof b[0][0]=="undefined")b=Matrix.create(b).elements;if(!this.isSameSizeAs(b))return null;return this.map(function(c,d,e){return c-b[d-1][e-1]})},canMultiplyFromLeft:function(a){a=a.elements||a;if(typeof a[0][0]=="undefined")a=Matrix.create(a).elements;return this.elements[0].length==a.length},multiply:function(a){if(!a.elements)return this.map(function(p){return p*a});var b=a.modulus?true:false,c=a.elements||a;if(typeof c[0][0]=="undefined")c=
Matrix.create(c).elements;if(!this.canMultiplyFromLeft(c))return null;var d=this.elements.length,e=d,f,g,h=c[0].length,i,k=this.elements[0].length,l=[],m,n,o;do{f=e-d;l[f]=[];g=h;do{i=h-g;m=0;n=k;do{o=k-n;m+=this.elements[f][o]*c[o][i]}while(--n);l[f][i]=m}while(--g)}while(--d);c=Matrix.create(l);return b?c.col(1):c},x:function(a){return this.multiply(a)},minor:function(a,b,c,d){var e=[],f=c,g,h,i,k=this.elements.length,l=this.elements[0].length;do{g=c-f;e[g]=[];h=d;do{i=d-h;e[g][i]=this.elements[(a+
g-1)%k][(b+i-1)%l]}while(--h)}while(--f);return Matrix.create(e)},transpose:function(){var a=this.elements.length,b=this.elements[0].length,c=[],d=b,e,f,g;do{e=b-d;c[e]=[];f=a;do{g=a-f;c[e][g]=this.elements[g][e]}while(--f)}while(--d);return Matrix.create(c)},isSquare:function(){return this.elements.length==this.elements[0].length},max:function(){var a=0,b=this.elements.length,c=b,d,e,f=this.elements[0].length,g;do{d=c-b;e=f;do{g=f-e;if(Math.abs(this.elements[d][g])>Math.abs(a))a=this.elements[d][g]}while(--e)}while(--b);
return a},indexOf:function(a){var b=this.elements.length,c=b,d,e,f=this.elements[0].length,g;do{d=c-b;e=f;do{g=f-e;if(this.elements[d][g]==a)return{i:d+1,j:g+1}}while(--e)}while(--b);return null},diagonal:function(){if(!this.isSquare)return null;var a=[],b=this.elements.length,c=b,d;do{d=c-b;a.push(this.elements[d][d])}while(--b);return Vector.create(a)},toRightTriangular:function(){var a=this.dup(),b,c=this.elements.length,d=c,e,f,g=this.elements[0].length,h;do{e=d-c;if(a.elements[e][e]==0)for(j=
e+1;j<d;j++)if(a.elements[j][e]!=0){b=[];f=g;do{h=g-f;b.push(a.elements[e][h]+a.elements[j][h])}while(--f);a.elements[e]=b;break}if(a.elements[e][e]!=0)for(j=e+1;j<d;j++){var i=a.elements[j][e]/a.elements[e][e];b=[];f=g;do{h=g-f;b.push(h<=e?0:a.elements[j][h]-a.elements[e][h]*i)}while(--f);a.elements[j]=b}}while(--c);return a},toUpperTriangular:function(){return this.toRightTriangular()},determinant:function(){if(!this.isSquare())return null;var a=this.toRightTriangular(),b=a.elements[0][0],c=a.elements.length-
1,d=c,e;do{e=d-c+1;b*=a.elements[e][e]}while(--c);return b},det:function(){return this.determinant()},isSingular:function(){return this.isSquare()&&this.determinant()===0},trace:function(){if(!this.isSquare())return null;var a=this.elements[0][0],b=this.elements.length-1,c=b,d;do{d=c-b+1;a+=this.elements[d][d]}while(--b);return a},tr:function(){return this.trace()},rank:function(){var a=this.toRightTriangular(),b=0,c=this.elements.length,d=c,e,f,g=this.elements[0].length,h;do{e=d-c;f=g;do{h=g-f;if(Math.abs(a.elements[e][h])>
Sylvester.precision){b++;break}}while(--f)}while(--c);return b},rk:function(){return this.rank()},augment:function(a){a=a.elements||a;if(typeof a[0][0]=="undefined")a=Matrix.create(a).elements;var b=this.dup(),c=b.elements[0].length,d=b.elements.length,e=d,f,g,h=a[0].length,i;if(d!=a.length)return null;do{f=e-d;g=h;do{i=h-g;b.elements[f][c+i]=a[f][i]}while(--g)}while(--d);return b},inverse:function(){if(!this.isSquare()||this.isSingular())return null;var a=this.elements.length,b=a,c,d,e=this.augment(Matrix.I(a)).toRightTriangular(),
f,g=e.elements[0].length,h,i,k=[],l;do{c=a-1;i=[];f=g;k[c]=[];d=e.elements[c][c];do{h=g-f;l=e.elements[c][h]/d;i.push(l);h>=b&&k[c].push(l)}while(--f);e.elements[c]=i;for(d=0;d<c;d++){i=[];f=g;do{h=g-f;i.push(e.elements[d][h]-e.elements[c][h]*e.elements[d][c])}while(--f);e.elements[d]=i}}while(--a);return Matrix.create(k)},inv:function(){return this.inverse()},round:function(){return this.map(function(a){return Math.round(a)})},snapTo:function(a){return this.map(function(b){return Math.abs(b-a)<=
Sylvester.precision?a:b})},inspect:function(){var a=[],b=this.elements.length,c=b,d;do{d=c-b;a.push(Vector.create(this.elements[d]).inspect())}while(--b);return a.join("\n")},setElements:function(a){var b=a.elements||a;if(typeof b[0][0]!="undefined"){var c=b.length,d=c,e,f,g;this.elements=[];do{a=d-c;f=e=b[a].length;this.elements[a]=[];do{g=f-e;this.elements[a][g]=b[a][g]}while(--e)}while(--c);return this}d=c=b.length;this.elements=[];do{a=d-c;this.elements.push([b[a]])}while(--c);return this}};
Matrix.create=function(a){return(new Matrix).setElements(a)};Matrix.I=function(a){var b=[],c=a,d,e,f;do{d=c-a;b[d]=[];e=c;do{f=c-e;b[d][f]=d==f?1:0}while(--e)}while(--a);return Matrix.create(b)};Matrix.Diagonal=function(a){var b=a.length,c=b,d,e=Matrix.I(b);do{d=c-b;e.elements[d][d]=a[d]}while(--b);return e};
Matrix.Rotation=function(a,b){if(!b)return Matrix.create([[Math.cos(a),-Math.sin(a)],[Math.sin(a),Math.cos(a)]]);var c=b.dup();if(c.elements.length!=3)return null;var d=c.modulus(),e=c.elements[0]/d,f=c.elements[1]/d;c=c.elements[2]/d;d=Math.sin(a);var g=Math.cos(a),h=1-g;return Matrix.create([[h*e*e+g,h*e*f-d*c,h*e*c+d*f],[h*e*f+d*c,h*f*f+g,h*f*c-d*e],[h*e*c-d*f,h*f*c+d*e,h*c*c+g]])};Matrix.RotationX=function(a){var b=Math.cos(a);a=Math.sin(a);return Matrix.create([[1,0,0],[0,b,-a],[0,a,b]])};
Matrix.RotationY=function(a){var b=Math.cos(a);a=Math.sin(a);return Matrix.create([[b,0,a],[0,1,0],[-a,0,b]])};Matrix.RotationZ=function(a){var b=Math.cos(a);a=Math.sin(a);return Matrix.create([[b,-a,0],[a,b,0],[0,0,1]])};Matrix.Random=function(a,b){return Matrix.Zero(a,b).map(function(){return Math.random()})};Matrix.Zero=function(a,b){var c=[],d=a,e,f,g;do{e=a-d;c[e]=[];f=b;do{g=b-f;c[e][g]=0}while(--f)}while(--d);return Matrix.create(c)};function Line(){}
Line.prototype={eql:function(a){return this.isParallelTo(a)&&this.contains(a.anchor)},dup:function(){return Line.create(this.anchor,this.direction)},translate:function(a){a=a.elements||a;return Line.create([this.anchor.elements[0]+a[0],this.anchor.elements[1]+a[1],this.anchor.elements[2]+(a[2]||0)],this.direction)},isParallelTo:function(a){if(a.normal)return a.isParallelTo(this);a=this.direction.angleFrom(a.direction);return Math.abs(a)<=Sylvester.precision||Math.abs(a-Math.PI)<=Sylvester.precision},
distanceFrom:function(a){if(a.normal)return a.distanceFrom(this);if(a.direction){if(this.isParallelTo(a))return this.distanceFrom(a.anchor);var b=this.direction.cross(a.direction).toUnitVector().elements,c=this.anchor.elements;a=a.anchor.elements;return Math.abs((c[0]-a[0])*b[0]+(c[1]-a[1])*b[1]+(c[2]-a[2])*b[2])}else{var d=a.elements||a;c=this.anchor.elements;b=this.direction.elements;a=d[0]-c[0];var e=d[1]-c[1];d=(d[2]||0)-c[2];c=Math.sqrt(a*a+e*e+d*d);if(c===0)return 0;b=(a*b[0]+e*b[1]+d*b[2])/
c;b=1-b*b;return Math.abs(c*Math.sqrt(b<0?0:b))}},contains:function(a){a=this.distanceFrom(a);return a!==null&&a<=Sylvester.precision},liesIn:function(a){return a.contains(this)},intersects:function(a){if(a.normal)return a.intersects(this);return!this.isParallelTo(a)&&this.distanceFrom(a)<=Sylvester.precision},intersectionWith:function(a){if(a.normal)return a.intersectionWith(this);if(!this.intersects(a))return null;var b=this.anchor.elements,c=this.direction.elements,d=a.anchor.elements,e=a.direction.elements;
a=c[0];var f=c[1];c=c[2];var g=e[0],h=e[1];e=e[2];var i=b[0]-d[0],k=b[1]-d[1];d=b[2]-d[2];var l=g*g+h*h+e*e,m=a*g+f*h+c*e;g=((-a*i-f*k-c*d)*l/(a*a+f*f+c*c)+m*(g*i+h*k+e*d))/(l-m*m);return Vector.create([b[0]+g*a,b[1]+g*f,b[2]+g*c])},pointClosestTo:function(a){if(a.direction){if(this.intersects(a))return this.intersectionWith(a);if(this.isParallelTo(a))return null;var b=this.direction.elements,c=a.direction.elements,d=b[0],e=b[1];b=b[2];var f=c[0],g=c[1],h=c[2];c=b*f-d*h;var i=d*g-e*f,k=e*h-b*g;d=
Vector.create([c*h-i*g,i*f-k*h,k*g-c*f]);a=Plane.create(a.anchor,d);return a.intersectionWith(this)}else{a=a.elements||a;if(this.contains(a))return Vector.create(a);c=this.anchor.elements;b=this.direction.elements;d=b[0];e=b[1];b=b[2];f=c[0];i=c[1];g=c[2];c=d*(a[1]-i)-e*(a[0]-f);i=e*((a[2]||0)-g)-b*(a[1]-i);k=b*(a[0]-f)-d*((a[2]||0)-g);d=Vector.create([e*c-b*k,b*i-d*c,d*k-e*i]);e=this.distanceFrom(a)/d.modulus();return Vector.create([a[0]+d.elements[0]*e,a[1]+d.elements[1]*e,(a[2]||0)+d.elements[2]*
e])}},rotate:function(a,b){if(typeof b.direction=="undefined")b=Line.create(b.to3D(),Vector.k);var c=Matrix.Rotation(a,b.direction).elements,d=b.pointClosestTo(this.anchor).elements,e=this.anchor.elements,f=this.direction.elements,g=d[0],h=d[1];d=d[2];var i=e[0]-g,k=e[1]-h;e=e[2]-d;return Line.create([g+c[0][0]*i+c[0][1]*k+c[0][2]*e,h+c[1][0]*i+c[1][1]*k+c[1][2]*e,d+c[2][0]*i+c[2][1]*k+c[2][2]*e],[c[0][0]*f[0]+c[0][1]*f[1]+c[0][2]*f[2],c[1][0]*f[0]+c[1][1]*f[1]+c[1][2]*f[2],c[2][0]*f[0]+c[2][1]*f[1]+
c[2][2]*f[2]])},reflectionIn:function(a){if(a.normal){var b=this.anchor.elements,c=this.direction.elements,d=b[0],e=b[1];b=b[2];var f=c[0],g=c[1],h=c[2];c=this.anchor.reflectionIn(a).elements;d+=f;e+=g;b+=h;a=a.pointClosestTo([d,e,b]).elements;return Line.create(c,[a[0]+(a[0]-d)-c[0],a[1]+(a[1]-e)-c[1],a[2]+(a[2]-b)-c[2]])}else if(a.direction)return this.rotate(Math.PI,a);else{a=a.elements||a;return Line.create(this.anchor.reflectionIn([a[0],a[1],a[2]||0]),this.direction)}},setVectors:function(a,
b){a=Vector.create(a);b=Vector.create(b);a.elements.length==2&&a.elements.push(0);b.elements.length==2&&b.elements.push(0);if(a.elements.length>3||b.elements.length>3)return null;var c=b.modulus();if(c===0)return null;this.anchor=a;this.direction=Vector.create([b.elements[0]/c,b.elements[1]/c,b.elements[2]/c]);return this}};Line.create=function(a,b){return(new Line).setVectors(a,b)};Line.X=Line.create(Vector.Zero(3),Vector.i);Line.Y=Line.create(Vector.Zero(3),Vector.j);
Line.Z=Line.create(Vector.Zero(3),Vector.k);function Plane(){}
Plane.prototype={eql:function(a){return this.contains(a.anchor)&&this.isParallelTo(a)},dup:function(){return Plane.create(this.anchor,this.normal)},translate:function(a){a=a.elements||a;return Plane.create([this.anchor.elements[0]+a[0],this.anchor.elements[1]+a[1],this.anchor.elements[2]+(a[2]||0)],this.normal)},isParallelTo:function(a){if(a.normal){a=this.normal.angleFrom(a.normal);return Math.abs(a)<=Sylvester.precision||Math.abs(Math.PI-a)<=Sylvester.precision}else if(a.direction)return this.normal.isPerpendicularTo(a.direction);
return null},isPerpendicularTo:function(a){a=this.normal.angleFrom(a.normal);return Math.abs(Math.PI/2-a)<=Sylvester.precision},distanceFrom:function(a){if(this.intersects(a)||this.contains(a))return 0;if(a.anchor){var b=this.anchor.elements,c=a.anchor.elements;a=this.normal.elements;return Math.abs((b[0]-c[0])*a[0]+(b[1]-c[1])*a[1]+(b[2]-c[2])*a[2])}else{c=a.elements||a;b=this.anchor.elements;a=this.normal.elements;return Math.abs((b[0]-c[0])*a[0]+(b[1]-c[1])*a[1]+(b[2]-(c[2]||0))*a[2])}},contains:function(a){if(a.normal)return null;
if(a.direction)return this.contains(a.anchor)&&this.contains(a.anchor.add(a.direction));else{a=a.elements||a;var b=this.anchor.elements,c=this.normal.elements;return Math.abs(c[0]*(b[0]-a[0])+c[1]*(b[1]-a[1])+c[2]*(b[2]-(a[2]||0)))<=Sylvester.precision}},intersects:function(a){if(typeof a.direction=="undefined"&&typeof a.normal=="undefined")return null;return!this.isParallelTo(a)},intersectionWith:function(a){if(!this.intersects(a))return null;if(a.direction){var b=a.anchor.elements,c=a.direction.elements;
a=this.anchor.elements;var d=this.normal.elements;a=(d[0]*(a[0]-b[0])+d[1]*(a[1]-b[1])+d[2]*(a[2]-b[2]))/(d[0]*c[0]+d[1]*c[1]+d[2]*c[2]);return Vector.create([b[0]+c[0]*a,b[1]+c[1]*a,b[2]+c[2]*a])}else if(a.normal){c=this.normal.cross(a.normal).toUnitVector();d=this.normal.elements;b=this.anchor.elements;var e=a.normal.elements,f=a.anchor.elements,g=Matrix.Zero(2,2);for(a=0;g.isSingular();){a++;g=Matrix.create([[d[a%3],d[(a+1)%3]],[e[a%3],e[(a+1)%3]]])}g=g.inverse().elements;b=d[0]*b[0]+d[1]*b[1]+
d[2]*b[2];d=e[0]*f[0]+e[1]*f[1]+e[2]*f[2];b=[g[0][0]*b+g[0][1]*d,g[1][0]*b+g[1][1]*d];d=[];for(e=1;e<=3;e++)d.push(a==e?0:b[(e+(5-a)%3)%3]);return Line.create(d,c)}},pointClosestTo:function(a){a=a.elements||a;var b=this.anchor.elements,c=this.normal.elements;b=(b[0]-a[0])*c[0]+(b[1]-a[1])*c[1]+(b[2]-(a[2]||0))*c[2];return Vector.create([a[0]+c[0]*b,a[1]+c[1]*b,(a[2]||0)+c[2]*b])},rotate:function(a,b){var c=Matrix.Rotation(a,b.direction).elements,d=b.pointClosestTo(this.anchor).elements,e=this.anchor.elements,
f=this.normal.elements,g=d[0],h=d[1];d=d[2];var i=e[0]-g,k=e[1]-h;e=e[2]-d;return Plane.create([g+c[0][0]*i+c[0][1]*k+c[0][2]*e,h+c[1][0]*i+c[1][1]*k+c[1][2]*e,d+c[2][0]*i+c[2][1]*k+c[2][2]*e],[c[0][0]*f[0]+c[0][1]*f[1]+c[0][2]*f[2],c[1][0]*f[0]+c[1][1]*f[1]+c[1][2]*f[2],c[2][0]*f[0]+c[2][1]*f[1]+c[2][2]*f[2]])},reflectionIn:function(a){if(a.normal){var b=this.anchor.elements,c=this.normal.elements,d=b[0],e=b[1];b=b[2];var f=c[0],g=c[1],h=c[2];c=this.anchor.reflectionIn(a).elements;d+=f;e+=g;b+=h;
a=a.pointClosestTo([d,e,b]).elements;return Plane.create(c,[a[0]+(a[0]-d)-c[0],a[1]+(a[1]-e)-c[1],a[2]+(a[2]-b)-c[2]])}else if(a.direction)return this.rotate(Math.PI,a);else{a=a.elements||a;return Plane.create(this.anchor.reflectionIn([a[0],a[1],a[2]||0]),this.normal)}},setVectors:function(a,b,c){a=Vector.create(a);a=a.to3D();if(a===null)return null;b=Vector.create(b);b=b.to3D();if(b===null)return null;if(typeof c=="undefined")c=null;else{c=Vector.create(c);c=c.to3D();if(c===null)return null}var d=
a.elements[0],e=a.elements[1],f=a.elements[2],g=b.elements[0],h=b.elements[1],i=b.elements[2];if(c!==null){b=c.elements[0];var k=c.elements[1];c=c.elements[2];e=Vector.create([(h-e)*(c-f)-(i-f)*(k-e),(i-f)*(b-d)-(g-d)*(c-f),(g-d)*(k-e)-(h-e)*(b-d)]);d=e.modulus();if(d===0)return null;e=Vector.create([e.elements[0]/d,e.elements[1]/d,e.elements[2]/d])}else{d=Math.sqrt(g*g+h*h+i*i);if(d===0)return null;e=Vector.create([b.elements[0]/d,b.elements[1]/d,b.elements[2]/d])}this.anchor=a;this.normal=e;return this}};
Plane.create=function(a,b,c){return(new Plane).setVectors(a,b,c)};Plane.XY=Plane.create(Vector.Zero(3),Vector.k);Plane.YZ=Plane.create(Vector.Zero(3),Vector.i);Plane.ZX=Plane.create(Vector.Zero(3),Vector.j);Plane.YX=Plane.XY;Plane.ZY=Plane.YZ;Plane.XZ=Plane.ZX;var $V=Vector.create,$M=Matrix.create,$L=Line.create,$P=Plane.create;Matrix.Translation=function(a){if(a.elements.length==2){var b=Matrix.I(3);b.elements[2][0]=a.elements[0];b.elements[2][1]=a.elements[1];return b}if(a.elements.length==3){b=Matrix.I(4);b.elements[0][3]=a.elements[0];b.elements[1][3]=a.elements[1];b.elements[2][3]=a.elements[2];return b}throw"Invalid length for Translation";};
Matrix.prototype.flatten=function(){var a=[];if(this.elements.length==0)return[];for(var b=0;b<this.elements[0].length;b++)for(var c=0;c<this.elements.length;c++)a.push(this.elements[c][b]);return a};
Matrix.prototype.ensure4x4=function(){if(this.elements.length==4&&this.elements[0].length==4)return this;if(this.elements.length>4||this.elements[0].length>4)return null;for(var a=0;a<this.elements.length;a++)for(var b=this.elements[a].length;b<4;b++)a==b?this.elements[a].push(1):this.elements[a].push(0);for(a=this.elements.length;a<4;a++)if(a==0)this.elements.push([1,0,0,0]);else if(a==1)this.elements.push([0,1,0,0]);else if(a==2)this.elements.push([0,0,1,0]);else a==3&&this.elements.push([0,0,0,
1]);return this};Matrix.prototype.make3x3=function(){if(this.elements.length!=4||this.elements[0].length!=4)return null;return Matrix.create([[this.elements[0][0],this.elements[0][1],this.elements[0][2]],[this.elements[1][0],this.elements[1][1],this.elements[1][2]],[this.elements[2][0],this.elements[2][1],this.elements[2][2]]])};Vector.prototype.flatten=function(){return this.elements};
function mht(a){var b="";if(a.length==16)for(var c=0;c<4;c++)b+="<span style='font-family: monospace'>["+a[c*4+0].toFixed(4)+","+a[c*4+1].toFixed(4)+","+a[c*4+2].toFixed(4)+","+a[c*4+3].toFixed(4)+"]</span><br>";else if(a.length==9)for(c=0;c<3;c++)b+="<span style='font-family: monospace'>["+a[c*3+0].toFixed(4)+","+a[c*3+1].toFixed(4)+","+a[c*3+2].toFixed(4)+"]</font><br>";else return a.toString();return b}
function makeLookAt(a,b,c,d,e,f,g,h,i){var k=$V([a,b,c]);d=$V([d,e,f]);g=$V([g,h,i]);k=k.subtract(d).toUnitVector();g=g.cross(k).toUnitVector();h=k.cross(g).toUnitVector();k=$M([[g.e(1),g.e(2),g.e(3),0],[h.e(1),h.e(2),h.e(3),0],[k.e(1),k.e(2),k.e(3),0],[0,0,0,1]]);a=$M([[1,0,0,-a],[0,1,0,-b],[0,0,1,-c],[0,0,0,1]]);return k.x(a)}function makePerspective(a,b,c,d){a=c*Math.tan(a*Math.PI/360);var e=-a;return makeFrustum(e*b,a*b,e,a,c,d)}
function makeFrustum(a,b,c,d,e,f){return $M([[2*e/(b-a),0,(b+a)/(b-a),0],[0,2*e/(d-c),(d+c)/(d-c),0],[0,0,-(f+e)/(f-e),-2*f*e/(f-e)],[0,0,-1,0]])}function makeOrtho(a,b,c,d,e,f){return $M([[2/(b-a),0,0,-(b+a)/(b-a)],[0,2/(d-c),0,-(d+c)/(d-c)],[0,0,-2/(f-e),-(f+e)/(f-e)],[0,0,0,1]])};Engine=function(){this.gl=pMatrix=mvMatrix=null};
Engine.prototype.initialize=function(a){var b=document.getElementById(a);this.initGL(b);this.initSettings();this.initShaders();this.initBuffers();this.initTextures();var c=this;b.addEventListener("mousedown",function(d){curX=d.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-b.offsetLeft;curY=d.clientY+document.body.scrollTop+document.documentElement.scrollTop-b.offsetTop;c.mouseDown!=undefined&&c.mouseDown(curX,curY)},false);b.addEventListener("mouseup",function(d){curX=d.clientX+
document.body.scrollLeft+document.documentElement.scrollLeft-b.offsetLeft;curY=d.clientY+document.body.scrollTop+document.documentElement.scrollTop-b.offsetTop;c.mouseUp!=undefined&&c.mouseUp(curX,curY)},false);b.addEventListener("mousemove",function(d){curX=d.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-b.offsetLeft;curY=d.clientY+document.body.scrollTop+document.documentElement.scrollTop-b.offsetTop;c.mouseMove!=undefined&&c.mouseMove(curX,curY)},false);b.setAttribute("tabindex",
"10000");window.addEventListener("keydown",function(d){var e=d.shiftKey,f=d.altKey,g=d.ctrlKey;c.keyDown!=undefined&&c.keyDown(d.keyCode,e,f,g)},false);window.addEventListener("keyup",function(d){var e=d.shiftKey,f=d.altKey,g=d.ctrlKey;c.keyUp!=undefined&&c.keyUp(d.keyCode,e,f,g)},false)};Engine.prototype.initSettings=function(){this.gl.clearColor(0,0,0,1);this.gl.clearDepth(1);this.gl.enable(this.gl.DEPTH_TEST);this.gl.depthFunc(this.gl.LEQUAL)};
Engine.prototype.start=function(a,b){setInterval(a,1E3/b)};Engine.prototype.initGL=function(a){try{this.gl=a.getContext("experimental-webgl");this.gl.viewportWidth=a.width;this.gl.viewportHeight=a.height}catch(b){}this.gl||alert("Could not initialise WebGL, sorry :-(")};Engine.prototype.initShaders=function(){};Engine.prototype.initBuffers=function(){};Engine.prototype.initTextures=function(){};Engine.prototype.loadIdentity=function(){this.mvMatrix=Matrix.I(4)};
Engine.prototype.multMatrix=function(a){this.mvMatrix=this.mvMatrix.x(a)};Engine.prototype.mvScale=function(a){var b=Matrix.I(4);b.elements[0][0]=a[0];b.elements[1][1]=a[1];b.elements[2][2]=a[2];b.elements[3][3]=a[3];this.multMatrix(b)};Engine.prototype.mvTranslate=function(a){this.multMatrix(Matrix.Translation($V([a[0],a[1],a[2]])).ensure4x4())};Engine.prototype.mvRotate=function(a,b){this.multMatrix(Matrix.Rotation(Math.rad(a),$V([b[0],b[1],b[2]])).ensure4x4())};
Engine.prototype.perspective=function(a,b,c,d){this.pMatrix=makePerspective(a,b,c,d)};Engine.prototype.ortho=function(a,b){this.pMatrix=makeOrtho(0,a,b,0,0,100)};Engine.prototype.run=function(){};
Engine.prototype.getShader=function(a){var b=document.getElementById(a);if(!b)return null;a="";for(var c=b.firstChild;c;){if(c.nodeType==3)a+=c.textContent;c=c.nextSibling}if(b.type=="x-shader/x-fragment")b=this.gl.createShader(this.gl.FRAGMENT_SHADER);else if(b.type=="x-shader/x-vertex")b=this.gl.createShader(this.gl.VERTEX_SHADER);else return null;this.gl.shaderSource(b,a);this.gl.compileShader(b);if(!this.gl.getShaderParameter(b,this.gl.COMPILE_STATUS)){alert(this.gl.getShaderInfoLog(b));return null}return b};
Engine.prototype.createShaderProgram=function(a){var b=this.gl.createProgram(),c;for(c in a)this.gl.attachShader(b,this.getShader(a[c]));this.gl.linkProgram(b);this.gl.getProgramParameter(b,this.gl.LINK_STATUS)||alert("Could not initialise shaders");return b};Engine.prototype.createBuffer=function(a,b,c){var d=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,d);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(a),this.gl.STATIC_DRAW);d.itemSize=b;d.numItems=c;return d};
Engine.prototype.handleLoadedTexture=function(a){this.gl.bindTexture(this.gl.TEXTURE_2D,a);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,true);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,a.image);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);this.gl.bindTexture(this.gl.TEXTURE_2D,
null)};Engine.prototype.loadTexture=function(a){var b=this.gl.createTexture();b.image=a;this.handleLoadedTexture(b);return b};var soy=soy||{};(function(){var a=navigator.userAgent,b=a.indexOf("Opera")==0;soy.IS_OPERA_=b;soy.IS_IE_=!b&&a.indexOf("MSIE")!=-1;soy.IS_WEBKIT_=!b&&a.indexOf("WebKit")!=-1})();soy.StringBuilder=function(a){this.buffer_=soy.IS_IE_?[]:"";a!=null&&this.append.apply(this,arguments)};soy.StringBuilder.prototype.bufferLength_=0;
soy.StringBuilder.prototype.append=function(a,b){if(soy.IS_IE_)if(b==null)this.buffer_[this.bufferLength_++]=a;else{this.buffer_.push.apply(this.buffer_,arguments);this.bufferLength_=this.buffer_.length}else{this.buffer_+=a;if(b!=null)for(var c=1;c<arguments.length;c++)this.buffer_+=arguments[c]}return this};soy.StringBuilder.prototype.clear=function(){if(soy.IS_IE_)this.bufferLength_=this.buffer_.length=0;else this.buffer_=""};
soy.StringBuilder.prototype.toString=function(){if(soy.IS_IE_){var a=this.buffer_.join("");this.clear();a&&this.append(a);return a}else return this.buffer_};soy.renderElement=function(a,b,c){a.innerHTML=b(c)};soy.renderAsFragment=function(a,b){var c=document.createElement("div");c.innerHTML=a(b);if(c.childNodes.length==1)return c.firstChild;else{for(var d=document.createDocumentFragment();c.firstChild;)d.appendChild(c.firstChild);return d}};
soy.$$augmentData=function(a,b){function c(){}c.prototype=a;var d=new c,e;for(e in b)d[e]=b[e];return d};soy.$$escapeHtml=function(a){a=String(a);if(!soy.$$EscapeHtmlRe_.ALL_SPECIAL_CHARS.test(a))return a;if(a.indexOf("&")!=-1)a=a.replace(soy.$$EscapeHtmlRe_.AMP,"&amp;");if(a.indexOf("<")!=-1)a=a.replace(soy.$$EscapeHtmlRe_.LT,"&lt;");if(a.indexOf(">")!=-1)a=a.replace(soy.$$EscapeHtmlRe_.GT,"&gt;");if(a.indexOf('"')!=-1)a=a.replace(soy.$$EscapeHtmlRe_.QUOT,"&quot;");return a};
soy.$$EscapeHtmlRe_={ALL_SPECIAL_CHARS:/[&<>\"]/,AMP:/&/g,LT:/</g,GT:/>/g,QUOT:/\"/g};soy.$$escapeJs=function(a){a=String(a);for(var b=[],c=0;c<a.length;c++)b[c]=soy.$$escapeChar(a.charAt(c));return b.join("")};soy.$$escapeChar=function(a){if(a in soy.$$escapeCharJs_)return soy.$$escapeCharJs_[a];var b=a,c=a.charCodeAt(0);if(c>31&&c<127)b=a;else{if(c<256){b="\\x";if(c<16||c>256)b+="0"}else{b="\\u";if(c<4096)b+="0"}b+=c.toString(16).toUpperCase()}return soy.$$escapeCharJs_[a]=b};
soy.$$escapeCharJs_={"\u0008":"\\b","\u000c":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\u000b":"\\x0B",'"':'\\"',"'":"\\'","\\":"\\\\"};soy.$$escapeUri=function(a){a=String(a);return soy.$$ENCODE_URI_REGEXP_.test(a)?a:encodeURIComponent(a)};soy.$$ENCODE_URI_REGEXP_=/^[a-zA-Z0-9\-_.!~*'()]*$/;
soy.$$insertWordBreaks=function(a,b){a=String(a);for(var c=[],d=0,e=false,f=false,g=0,h=0,i=0,k=a.length;i<k;++i){var l=a.charCodeAt(i);if(g>=b&&l!=soy.$$CharCode_.SPACE){c[d++]=a.substring(h,i);h=i;c[d++]=soy.WORD_BREAK_;g=0}if(e){if(l==soy.$$CharCode_.GREATER_THAN)e=false}else if(f)switch(l){case soy.$$CharCode_.SEMI_COLON:f=false;++g;break;case soy.$$CharCode_.LESS_THAN:f=false;e=true;break;case soy.$$CharCode_.SPACE:f=false;g=0}else switch(l){case soy.$$CharCode_.LESS_THAN:e=true;break;case soy.$$CharCode_.AMPERSAND:f=
true;break;case soy.$$CharCode_.SPACE:g=0;break;default:++g}}c[d++]=a.substring(h);return c.join("")};soy.$$CharCode_={SPACE:32,AMPERSAND:38,SEMI_COLON:59,LESS_THAN:60,GREATER_THAN:62};soy.WORD_BREAK_=soy.IS_WEBKIT_?"<wbr></wbr>":soy.IS_OPERA_?"&shy;":"<wbr>";soy.$$changeNewlineToBr=function(a){a=String(a);if(!soy.$$CHANGE_NEWLINE_TO_BR_RE_.test(a))return a;return a.replace(/(\r\n|\r|\n)/g,"<br>")};soy.$$CHANGE_NEWLINE_TO_BR_RE_=/[\r\n]/;
soy.$$bidiTextDir=function(a,b){a=soy.$$bidiStripHtmlIfNecessary_(a,b);if(!a)return 0;return soy.$$bidiDetectRtlDirectionality_(a)?-1:1};soy.$$bidiDirAttr=function(a,b,c){b=soy.$$bidiTextDir(b,c);if(b!=a)return b<0?"dir=rtl":b>0?"dir=ltr":"";return""};soy.$$bidiMarkAfter=function(a,b,c){var d=soy.$$bidiTextDir(b,c);return soy.$$bidiMarkAfterKnownDir(a,d,b,c)};
soy.$$bidiMarkAfterKnownDir=function(a,b,c,d){return a>0&&(b<0||soy.$$bidiIsRtlExitText_(c,d))?"\u200e":a<0&&(b>0||soy.$$bidiIsLtrExitText_(c,d))?"\u200f":""};soy.$$bidiStripHtmlIfNecessary_=function(a,b){return b?a.replace(soy.$$BIDI_HTML_SKIP_RE_," "):a};soy.$$BIDI_HTML_SKIP_RE_=/<[^>]*>|&[^;]+;/g;
soy.$$bidiSpanWrap=function(a,b){b=String(b);var c=soy.$$bidiTextDir(b,true),d=soy.$$bidiMarkAfterKnownDir(a,c,b,true);if(c>0&&a<=0)b="<span dir=ltr>"+b+"</span>";else if(c<0&&a>=0)b="<span dir=rtl>"+b+"</span>";return b+d};soy.$$bidiUnicodeWrap=function(a,b){b=String(b);var c=soy.$$bidiTextDir(b,true),d=soy.$$bidiMarkAfterKnownDir(a,c,b,true);if(c>0&&a<=0)b="\u202a"+b+"\u202c";else if(c<0&&a>=0)b="\u202b"+b+"\u202c";return b+d};soy.$$bidiLtrChars_="A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02b8\u0300-\u0590\u0800-\u1fff\u2c00-\ufb1c\ufdfe-\ufe6f\ufefd-\uffff";
soy.$$bidiNeutralChars_="\u0000- !-@[-`{-\u00bf\u00d7\u00f7\u02b9-\u02ff\u2000-\u2bff";soy.$$bidiRtlChars_="\u0591-\u07ff\ufb1d-\ufdfd\ufe70-\ufefc";soy.$$bidiRtlDirCheckRe_=RegExp("^[^"+soy.$$bidiLtrChars_+"]*["+soy.$$bidiRtlChars_+"]");soy.$$bidiNeutralDirCheckRe_=RegExp("^["+soy.$$bidiNeutralChars_+"]*$|^http://");soy.$$bidiIsRtlText_=function(a){return soy.$$bidiRtlDirCheckRe_.test(a)};soy.$$bidiIsNeutralText_=function(a){return soy.$$bidiNeutralDirCheckRe_.test(a)};
soy.$$bidiRtlDetectionThreshold_=0.4;soy.$$bidiRtlWordRatio_=function(a){var b=0,c=0;a=a.split(" ");for(var d=0;d<a.length;d++)if(soy.$$bidiIsRtlText_(a[d])){b++;c++}else soy.$$bidiIsNeutralText_(a[d])||c++;return c==0?0:b/c};soy.$$bidiDetectRtlDirectionality_=function(a){return soy.$$bidiRtlWordRatio_(a)>soy.$$bidiRtlDetectionThreshold_};soy.$$bidiLtrExitDirCheckRe_=RegExp("["+soy.$$bidiLtrChars_+"][^"+soy.$$bidiRtlChars_+"]*$");
soy.$$bidiRtlExitDirCheckRe_=RegExp("["+soy.$$bidiRtlChars_+"][^"+soy.$$bidiLtrChars_+"]*$");soy.$$bidiIsLtrExitText_=function(a,b){a=soy.$$bidiStripHtmlIfNecessary_(a,b);return soy.$$bidiLtrExitDirCheckRe_.test(a)};soy.$$bidiIsRtlExitText_=function(a,b){a=soy.$$bidiStripHtmlIfNecessary_(a,b);return soy.$$bidiRtlExitDirCheckRe_.test(a)};if(typeof shaders=="undefined")var shaders={};
shaders.create_vertex_shader=function(a,b){var c=b||new soy.StringBuilder;c.append('<script id="sprite-shader-vs" type="x-shader/x-vertex">attribute vec3 aVertexPosition;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform vec4 vMulColor;\n\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main(void) {\ngl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\nvColor = vMulColor*aVertexColor;\nvTextureCoord = aTextureCoord;\n}<\/script>');if(!b)return c.toString()};if(typeof shaders=="undefined")shaders={};
shaders.create_fragment_shader=function(a,b){var c=b||new soy.StringBuilder;c.append('<script id="sprite-shader-fs" type="x-shader/x-fragment">#ifdef GL_ES\nprecision highp float;\n#endif\n\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform float startS;\nuniform float endS;\nuniform float startT;\nuniform float endT;\n\nvoid main(void) {\nfloat s = vTextureCoord.s*endS+startS;\nfloat t = vTextureCoord.t*endT+startT;\ngl_FragColor = vColor*texture2D(uSampler, vec2(s,t));\n}<\/script>');if(!b)return c.toString()};SpriteEngine=function(){this.shaderProgram=null;this.vMulColor=[1,1,1,1];this.identity()};SpriteEngine.prototype=new Engine;SpriteEngine.prototype.constructor=SpriteEngine;
SpriteEngine.prototype.initSettings=function(){Engine.prototype.initSettings.call(this);this.gl.enable(this.gl.BLEND);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE);this.f32pMatrix=new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]);this.f32mvMatrix=new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]);this.f32mMulColor=new Float32Array([1,1,1,1])};
SpriteEngine.prototype.initShaders=function(){document.head.innerHTML+=shaders.create_fragment_shader();document.head.innerHTML+=shaders.create_vertex_shader();this.shaderProgram=this.createShaderProgram(["sprite-shader-fs","sprite-shader-vs"]);this.gl.useProgram(this.shaderProgram);this.shaderProgram.vertexPositionAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexPosition");this.gl.enableVertexAttribArray(this.shaderProgram.vertexPositionAttribute);this.shaderProgram.vertexColorAttribute=
this.gl.getAttribLocation(this.shaderProgram,"aVertexColor");this.gl.enableVertexAttribArray(this.shaderProgram.vertexColorAttribute);this.shaderProgram.textureCoordAttribute=this.gl.getAttribLocation(this.shaderProgram,"aTextureCoord");this.gl.enableVertexAttribArray(this.shaderProgram.textureCoordAttribute);this.shaderProgram.pMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uPMatrix");this.shaderProgram.mvMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uMVMatrix");this.shaderProgram.uSampler=
this.gl.getUniformLocation(this.shaderProgram,"uSampler");this.shaderProgram.vMulColor=this.gl.getUniformLocation(this.shaderProgram,"vMulColor");this.shaderProgram.startS=this.gl.getUniformLocation(this.shaderProgram,"startS");this.shaderProgram.endS=this.gl.getUniformLocation(this.shaderProgram,"endS");this.shaderProgram.startT=this.gl.getUniformLocation(this.shaderProgram,"startT");this.shaderProgram.endT=this.gl.getUniformLocation(this.shaderProgram,"endT")};
SpriteEngine.prototype.setUniforms=function(){for(var a=this.pMatrix.flatten(),b=0;b<16;b++)this.f32pMatrix[b]=a[b];this.gl.uniformMatrix4fv(this.shaderProgram.pMatrixUniform,false,this.f32pMatrix);a=this.mvMatrix.flatten();for(b=0;b<16;b++)this.f32mvMatrix[b]=a[b];this.gl.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,false,this.f32mvMatrix);this.f32mMulColor[0]=this.vMulColor[0];this.f32mMulColor[1]=this.vMulColor[1];this.f32mMulColor[2]=this.vMulColor[2];this.f32mMulColor[3]=this.vMulColor[3];
this.gl.uniform4fv(this.shaderProgram.vMulColor,this.f32mMulColor)};
SpriteEngine.prototype.renderSprite=function(a,b,c,d,e){var f=a.positionBuffer,g=a.colorBuffer,h=a.uvBuffer;a=a.texture;var i=a.image.width,k=a.image.height;if(b==undefined)b=0;if(d==undefined)d=i;if(c==undefined)c=0;if(e==undefined)e=k;this.gl.bindBuffer(this.gl.ARRAY_BUFFER,f);this.gl.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute,f.itemSize,this.gl.FLOAT,false,0,0);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g);this.gl.vertexAttribPointer(this.shaderProgram.vertexColorAttribute,g.itemSize,
this.gl.FLOAT,false,0,0);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,h);this.gl.vertexAttribPointer(this.shaderProgram.textureCoordAttribute,h.itemSize,this.gl.FLOAT,false,0,0);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,a);this.gl.uniform1i(this.shaderProgram.samplerUniform,0);this.setUniforms();this.gl.uniform1f(this.shaderProgram.startS,b/i);this.gl.uniform1f(this.shaderProgram.endS,d/i);this.gl.uniform1f(this.shaderProgram.startT,(k-(c+e))/k);this.gl.uniform1f(this.shaderProgram.endT,
e/k);this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,f.numItems)};SpriteEngine.prototype.createSprite=function(a){var b=this.createBuffer([a.width,a.height,0,0,a.height,0,a.width,0,0,0,0,0],3,4),c=this.createBuffer([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],4,4),d=this.createBuffer([1,0,0,0,1,1,0,1],2,4);return{positionBuffer:b,colorBuffer:c,uvBuffer:d,texture:this.loadTexture(a)}};
SpriteEngine.prototype.drawSprite=function(a,b,c,d,e,f,g,h,i,k){var l=a.texture.image.width,m=a.texture.image.height;if(d==undefined)d=0;if(e==undefined)e=1;if(f==undefined)f=1;if(g==undefined)g=0;if(h==undefined)h=l;if(i==undefined)i=0;if(k==undefined)k=m;d=Math.rad(d);this.mvMatrix.elements[0][0]=e*Math.cos(d);this.mvMatrix.elements[1][0]=Math.sin(d);this.mvMatrix.elements[2][0]=0;this.mvMatrix.elements[3][0]=0;this.mvMatrix.elements[0][1]=-Math.sin(d);this.mvMatrix.elements[1][1]=f*Math.cos(d);
this.mvMatrix.elements[2][1]=0;this.mvMatrix.elements[3][1]=0;this.mvMatrix.elements[0][2]=0;this.mvMatrix.elements[1][2]=0;this.mvMatrix.elements[2][2]=1;this.mvMatrix.elements[3][2]=0;this.mvMatrix.elements[0][3]=b;this.mvMatrix.elements[1][3]=c;this.mvMatrix.elements[2][3]=0;this.mvMatrix.elements[3][3]=1;engine.renderSprite(a,g,i,h,k)};
SpriteEngine.prototype.drawSpriteCentered=function(a,b,c,d,e,f,g,h,i,k){var l=a.texture.image.width,m=a.texture.image.height;if(d==undefined)d=0;if(e==undefined)e=1;if(f==undefined)f=1;if(g==undefined)g=0;if(h==undefined)h=l;if(i==undefined)i=0;if(k==undefined)k=m;d=Math.rad(d);this.mvMatrix.elements[0][0]=e*Math.cos(d);this.mvMatrix.elements[1][0]=Math.sin(d);this.mvMatrix.elements[2][0]=0;this.mvMatrix.elements[3][0]=0;this.mvMatrix.elements[0][1]=-Math.sin(d);this.mvMatrix.elements[1][1]=f*Math.cos(d);
this.mvMatrix.elements[2][1]=0;this.mvMatrix.elements[3][1]=0;this.mvMatrix.elements[0][2]=0;this.mvMatrix.elements[1][2]=0;this.mvMatrix.elements[2][2]=1;this.mvMatrix.elements[3][2]=0;this.mvMatrix.elements[0][3]=b-l/2;this.mvMatrix.elements[1][3]=c-m/2;this.mvMatrix.elements[2][3]=0;this.mvMatrix.elements[3][3]=1;engine.renderSprite(a,g,i,h,k)};SpriteEngine.prototype.scale=function(a,b){this.mvScale([a,b,1,1])};SpriteEngine.prototype.move=function(a,b){this.mvTranslate([a,b,0])};
SpriteEngine.prototype.rotate=function(a){this.mvRotate(a,[0,0,1])};SpriteEngine.prototype.identity=function(){this.loadIdentity()};SpriteEngine.prototype.setTint=function(a,b,c){this.vMulColor=[a,b,c,this.vMulColor[3]]};SpriteEngine.prototype.setAlpha=function(a){this.vMulColor=[this.vMulColor[0],this.vMulColor[1],this.vMulColor[2],a]};SpriteEngine.prototype.clear=function(a,b,c){a!=undefined&&this.gl.clearColor(a,b,c,1);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)};
SpriteEngine.prototype.setView=function(){this.gl.viewport(0,0,this.gl.viewportWidth,this.gl.viewportHeight);this.ortho(this.gl.viewportWidth,this.gl.viewportHeight)};SpriteEngine.prototype.height=function(){return this.gl.viewportHeight};SpriteEngine.prototype.width=function(){return this.gl.viewportWidth};FontRenderer=function(a,b){this.engine=a;this.font=new Image;this.font_data=[];this.loaded=false;this.sprite=null;var c=this;this.font.onload=function(){c.sprite=a.createSprite(c.font);var d=document.createElement("canvas");d.width=c.font.width;d.height=c.font.height;d=d.getContext("2d");d.drawImage(c.font,0,0);d=d.getImageData(0,0,188,1).data;for(var e=0;e<188;e++)c.font_data.push(d[e*4+0]<<16|d[e*4+1]<<8|d[e*4+2]);c.loaded=true};this.font.src=b};
FontRenderer.prototype.drawText=function(a,b,c){if(this.loaded)for(var d=this.font.height-1,e=0;e<a.length;e++){var f=a.charCodeAt(e)-32,g=this.font_data[f*2];f=this.font_data[f*2+1]-g;this.renderCharacter(g,1,f,d,b,c);b+=f}};FontRenderer.prototype.renderCharacter=function(a,b,c,d,e,f){this.engine.drawSprite(this.sprite,e,f,0,c/this.sprite.texture.image.width,d/this.sprite.texture.image.height,a,c,b,d)};
